--En este archivo esta la creación de la base de datos, la creación de las tablas, de los procedimientos e insertar un dato para el login.

--Creación de base de datos 
CREATE DATABASE ControlEdificios;
GO

--Tabla de empleados
CREATE TABLE Empleados (
	EmpleadoID INT PRIMARY KEY,
	Nombre NVARCHAR(100) NOT NULL,
	Rol NVARCHAR(50) NOT NULL,
);

--Tabla EmpleadoZonas
CREATE TABLE EmpleadoZonas (
	EmpleadoID INT FOREIGN KEY REFERENCES Empleados(EmpleadoID),
	ZonasID INT FOREIGN KEY REFERENCES Zonas(ZonasID),
	PRIMARY KEY (EmpleadoID,ZonasID)
);

--Tabla de Usuarios
CREATE TABLE Usuarios(
	Usuario VARCHAR(50) NOT NULL,
	Contraseña NVARCHAR(50) NOT NULL,
	Rol NVARCHAR(50) NOT NULL
);

--Tabla de Visitantes
CREATE TABLE Visitantes (
	VisitanteID INT PRIMARY KEY,
	Nombre NVARCHAR(100) NOT NULL,
	Telefono NVARCHAR(50),
	MotivoVisita NVARCHAR(200)
);

--Tabla de Zonas
CREATE TABLE Zonas (
	ZonasID INT PRIMARY KEY IDENTITY(1,1),
	NombreZona NVARCHAR(50) NOT NULL,
	AccesoRestringido BIT NOT NULL
);

--Tabla de Accesos
CREATE TABLE Accesos (
	AccesoID INT PRIMARY KEY IDENTITY(1,1),
	EmpleadoID INT NULL, --Permite que sea null cuando sea un visitante 
	VisitanteID INT NULL, --Permite que sea null cuando sea un empleado
	ZonaID INT,
	FechaHoraEntrada DATETIME NOT NULL,
	FechaHoraSalida DATETIME,
	FOREIGN KEY (EmpleadoID) REFERENCES Empleados(EmpleadoID),
	FOREIGN KEY (ZonaID) REFERENCES Zonas(ZonasID),
	FOREIGN KEY (VisitanteID) REFERENCES Visitantes(VisitanteID)
);

--Tabla alerta de seguridad

CREATE TABLE AlertaSeguridad (
	AlertaID INT PRIMARY KEY IDENTITY(1,1),
	EmpleadoID INT NOT NULL,
	FechaHora DATETIME,
	TipoAlerta NVARCHAR(100),
	Descripcion NVARCHAR(200),
	FOREIGN KEY (EmpleadoID) REFERENCES Empleados(EmpleadoID)
);

--Tabla EmpleadoZonas
CREATE TABLE EmpleadoZonas(
	EmpleadoID INT FOREIGN KEY REFERENCES Empleados(EmpleadoID),
	ZonasID INT FOREIGN KEY REFERENCES Zonas(ZonasID)
	PRIMARY KEY (EmpleadoID,ZonasID)
);

-- PROCEDIMIENTOS

--Registrar empleado
CREATE PROCEDURE SP_RegistrarAccesoEmpleado
	@EmpleadoID INT,
	@ZonaID INT,
	@FechaEntrada DATETIME
AS
BEGIN
	INSERT INTO	ControlEdificios.dbo.Accesos (EmpleadoID, ZonaID, FechaHoraEntrada, VisitanteID)
	VALUES (@EmpleadoID, @ZonaID, @FechaEntrada, NULL);
END;

--Registrar visitante

CREATE PROCEDURE SP_RegistrarAccesoVisitante
    @VisitanteID INT,
    @ZonaID INT,
    @FechaEntrada DATETIME
AS
BEGIN
    INSERT INTO [ControlEdificios].[dbo].[Accesos] (VisitanteID, ZonaID, FechaHoraEntrada, EmpleadoID)
    VALUES (@VisitanteID, @ZonaID, @FechaEntrada, NULL);
END;


--Registrar Alerta

CREATE PROCEDURE SP_GenerarAlerta
	@EmpleadoID INT,
	@TipoAlerta NVARCHAR(100),
	@Descripcion NVARCHAR(200)
AS
BEGIN
	INSERT INTO [ControlEdificios].[dbo].[AlertaSeguridad] (EmpleadoID, FechaHora, TipoAlerta, Descripcion)
	VALUES (@EmpleadoID, GETDATE(), @TipoAlerta, @Descripcion);
END;

--Validar login
CREATE PROCEDURE SP_ValidarLogin
	@Usuario NVARCHAR(50),
	@Contraseña NVARCHAR(50)
AS
BEGIN
	SELECT Usuario, Contraseña, Rol
	FROM [ControlEdificios].[dbo].[Usuarios]
	WHERE Usuario = @Usuario AND Contraseña = @Contraseña;
END

-- Procedimiento Asignar Zona
CREATE PROCEDURE SP_AsignarZona
	@EmpleadoID INT,
	@Rol NVARCHAR(50)
AS
BEGIN
	DELETE FROM [ControlEdificios].[dbo].[EmpleadoZonas] WHERE EmpleadoID = @EmpleadoID

	IF @Rol = 'Empleado'
	BEGIN
		INSERT INTO EmpleadoZonas VALUES (@EmpleadoID, 1);
		INSERT INTO EmpleadoZonas VALUES (@EmpleadoID, 2);
		INSERT INTO EmpleadoZonas VALUES (@EmpleadoID, 3);
	END

	IF @Rol = 'Administrador'
	BEGIN
		INSERT INTO EmpleadoZonas VALUES (@EmpleadoID, 1);
		INSERT INTO EmpleadoZonas VALUES (@EmpleadoID, 2);
		INSERT INTO EmpleadoZonas VALUES (@EmpleadoID, 3);
		INSERT INTO EmpleadoZonas VALUES (@EmpleadoID, 4);
		INSERT INTO EmpleadoZonas VALUES (@EmpleadoID, 5);
	END

	IF @Rol = 'Seguridad'
	BEGIN
		INSERT INTO EmpleadoZonas VALUES (@EmpleadoID, 1);
		INSERT INTO EmpleadoZonas VALUES (@EmpleadoID, 2);
		INSERT INTO EmpleadoZonas VALUES (@EmpleadoID, 3);
		INSERT INTO EmpleadoZonas VALUES (@EmpleadoID, 4);
		INSERT INTO EmpleadoZonas VALUES (@EmpleadoID, 5);
		INSERT INTO EmpleadoZonas VALUES (@EmpleadoID, 6);
	END
END

INSERT INTO Usuarios (Usuario,Contraseña,Rol)

	VALUES ('Cristian','3000','Administrador')
INSERT INTO Usuarios (Usuario,Contraseña,Rol)

	VALUES ('Manuela','2000','Administrador')
INSERT INTO Usuarios (Usuario,Contraseña,Rol)

	VALUES ('Camilo','1000','Administrador')

INSERT INTO Zonas(NombreZona, AccesoRestringido)
VALUES ('Principal', 1)
INSERT INTO Zonas(NombreZona, AccesoRestringido)
VALUES ('Oficinas', 1)
INSERT INTO Zonas(NombreZona, AccesoRestringido)
VALUES ('Restaurante', 1)
INSERT INTO Zonas(NombreZona, AccesoRestringido)
VALUES ('Racks', 1)
INSERT INTO Zonas(NombreZona, AccesoRestringido)
VALUES ('Primeros Auxilios', 1)
INSERT INTO Zonas(NombreZona, AccesoRestringido)
VALUES ('Terraza', 1)
